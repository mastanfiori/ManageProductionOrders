/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","i2d/mpe/orders/manages1/model/formatter","sap/m/MessageBox"],function(j,J,F,a,S,f,M){"use strict";return{formatter:f,initAndOpen:function(p){var d=new sap.ui.core.Fragment.load({name:"i2d.mpe.orders.manages1.fragments.OrderSplitDialog",controller:this});var t=this;d.then(function(s){t._oOrderSplitDialog=s;t._oParentController=p.oParentController;s.attachEvent("afterClose",$.proxy(function(){s.destroy();},t));s.setModel(new J(p.oSelectedOrder),"OrderData");s.setModel(new J(p.oSelectedOperation),"OperationData");s.setModel(new J({sSelectedButtonKey:p.sSelectedButtonKey,sTitle:"",isTableSerialNumbersVisible:false,aSelectedSerialNumbers:[],ValueStateSplitQty:"None",ValueStateTextSplitQty:"None",ValueStateReworkQty:"None",ValueStateTextReworkQty:"None",SplitQty:"",ReworkQty:"",WBSElementIsEditable:false,OrderTypeIsEditable:false,dialogBusy:true,OrderHasParallelSequence:false,OrderHasReworkOperation:false,OrderTypeValueState:"None",ValueStateBasicSchedulingType:"None",ValueStateMaterialChild:"None",isPMMOActive:false,ChildOrder:"",ValueStateByProduct:"None"}),"OrderSplit");s.setModel(p.oi18nModel,"i18n");switch(p.sSelectedButtonKey){case"SPLT_DP":var T=p.oi18nModel.getResourceBundle().getText("splitOrderTitleDiffMat",[p.oSelectedOrder.ManufacturingOrder]);break;case"SPLT_SP":T=p.oi18nModel.getResourceBundle().getText("splitOrderTitleSameMat",[p.oSelectedOrder.ManufacturingOrder]);break;case"SPLT_OS":T=p.oi18nModel.getResourceBundle().getText("splitOrderTitleWarehouse",[p.oSelectedOrder.ManufacturingOrder]);break;}s.getModel("OrderSplit").setProperty("/sTitle",T);s.setModel(p.oDataModel);s.open();Promise.all([new Promise(function(r){p.oDataModel.read("/I_ProjMfgOrdTypePlntSplitSttg",{filters:[new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,p.oSelectedOrder.ProductionPlant)],success:function(D){r(D.results);},error:function(e){r([]);jQuery.sap.log.error(e);}});}),new Promise(function(r){var P=p.oDataModel.createKey("/I_MfgOrderForSplitInfo",{ManufacturingOrder:p.oSelectedOrder.ManufacturingOrder});p.oDataModel.read("/"+P,{success:function(D){r(D);},error:function(e){r({});jQuery.sap.log.error(e);}});}),new Promise(function(r){p.oDataModel.callFunction("/C_ManageProductionOrderCheckpmmoactive",{method:"POST",success:function(D){r(D);},error:function(e){r({});jQuery.sap.log.error(e);}});})]).then(function(P){var o=t._oOrderSplitDialog.getModel("OrderSplit");var O=P[0];if(O.length>0){var c=false;for(var i=0;i<O.length;i++){if(O[i].OrderType===p.oSelectedOrder.ManufacturingOrderType){c=true;o.setProperty("/WBSElementIsEditable",O[i].WBSElementIsEditable);o.setProperty("/OrderTypeIsEditable",O[i].OrderTypeIsEditable);break;}}if(!c){for(i=0;i<O.length;i++){if(O[i].OrderType===""){o.setProperty("/WBSElementIsEditable",O[i].WBSElementIsEditable);o.setProperty("/OrderTypeIsEditable",O[i].OrderTypeIsEditable);break;}}}if(o.getProperty("/OrderTypeIsEditable")){sap.ui.getCore().byId("idOSManufacturingOrderType").setValue(p.oSelectedOrder.ManufacturingOrderType);}}o.setProperty("/OrderHasParallelSequence",P[1].OrderHasParallelSequence);o.setProperty("/OrderHasReworkOperation",P[1].OrderHasReworkOperation);o.setProperty("/isPMMOActive",P[2].C_ManageProductionOrderCheckpmmoactive.Active==="X");sap.ui.getCore().byId("idOSBasicSchedulingType").setValue(p.oSelectedOrder.BasicSchedulingType);o.setProperty("/dialogBusy",false);});});},onBeforeRebindTable:function(e){var b=e.getParameter("bindingParams");var o=e.getSource().getModel("OrderData").getData();var O=e.getSource().getModel("OperationData").getData();b.filters.push(new sap.ui.model.Filter({filters:[new F("OrderInternalID",sap.ui.model.FilterOperator.EQ,o.OrderInternalBillOfOperations),new F("OrderOperationInternalID",sap.ui.model.FilterOperator.EQ,O.OrderIntBillOfOperationsItem)],and:true}));b.events={"dataReceived":function(E){if(E.getParameter("data").results.length>0){this._oOrderSplitDialog.getModel("OrderSplit").setProperty("/isTableSerialNumbersVisible",true);}else{this._oOrderSplitDialog.getModel("OrderSplit").setProperty("/isTableSerialNumbersVisible",false);}}.bind(this)};},onSelectionChangeSerialNumberTable:function(e){var s=e.getSource().getSelectedItems();var b=[];if(s.length>0){for(var i=0;i<s.length;i++){b.push(s[i].getBindingContext().getObject().SerialNumber);}e.getSource().getModel("OrderSplit").setProperty("/aSelectedSerialNumbers",b);}else{e.getSource().getModel("OrderSplit").setProperty("/aSelectedSerialNumbers",[]);}},onOk:function(e){if(this._isValidationDone()){e.getSource().getModel("OrderSplit").setProperty("/dialogBusy",true);var o=e.getSource().getModel("OrderData").getData();var O=e.getSource().getModel("OperationData").getData();var b=e.getSource().getModel("OrderSplit").getData();var s="";if(b.isTableSerialNumbersVisible){s=b.aSelectedSerialNumbers.join("|||");}var t=this;var u={ManufacturingOrder:o.ManufacturingOrder,ManufacturingOrderOperation:O.ManufacturingOrderOperation,WBSElement:b.WBSElementIsEditable?sap.ui.getCore().byId("idOSWBSElementInputChild").getValue():"",SalesDocument:o.SalesDocument===""?sap.ui.getCore().byId("idOSSalesDocument").getValue():o.SalesDocument,SalesDocumentItem:o.SalesDocumentItem==="000000"?sap.ui.getCore().byId("idOSSalesDocumenttem").getValue():o.SalesDocumentItem,ManufacturingOrderType:b.OrderTypeIsEditable?sap.ui.getCore().byId("idOSManufacturingOrderType").getValue():"",Mfgorderbasictartdate:sap.ui.getCore().byId("idOSBasicStartDate").getValue(),Mfgorderbasicenddate:sap.ui.getCore().byId("idOSBasicEndDate").getValue(),BasicSchedulingType:sap.ui.getCore().byId("idOSBasicSchedulingType").getValue(),Splitquantity:b.isTableSerialNumbersVisible?0:Number(b.SplitQty),Reworkquantity:b.isTableSerialNumbersVisible||b.OrderHasReworkOperation===""?0:b.ReworkQty,Operationunit:o.ProductionUnit,Byproduct:sap.ui.getCore().byId("idOSByProduct").getValue(),Storagelocation:sap.ui.getCore().byId("idOSStorageLocation").getValue(),Childmanufacturingorder:b.ChildOrder,Splitmethod:b.sSelectedButtonKey,Material:b.sSelectedButtonKey==="SPLT_DP"?sap.ui.getCore().byId("idOSMaterialChildSF").getValue():o.Material,Serialnumbers:s};this._oOrderSplitDialog.getModel().callFunction("/C_ManageProductionOrderSplitorder",{method:"POST",urlParameters:u,success:function(d,r){t._oOrderSplitDialog.getModel().refresh();t._oOrderSplitDialog.getModel("OrderSplit").setProperty("/dialogBusy",false);t._oOrderSplitDialog.close();M.success(t._oOrderSplitDialog.getModel("i18n").getResourceBundle().getText("splitSuccess"),{id:"splitSuccessMessageBox",actions:[t._oOrderSplitDialog.getModel("i18n").getResourceBundle().getText("displayRelatedOrdersButton"),M.Action.CLOSE],onClose:function(A){if(A===t._oOrderSplitDialog.getModel("i18n").getResourceBundle().getText("displayRelatedOrdersButton")){t._oParentController.onPressDisplayRelatedOrders();}}});},error:function(E){t._oOrderSplitDialog.getModel("OrderSplit").setProperty("/dialogBusy",false);}});}},_isValidationDone:function(){var o=this._oOrderSplitDialog.getModel("OrderSplit");var O=this._oOrderSplitDialog.getModel("OperationData");var v=true;if(o.getProperty("/OrderHasReworkOperation")==="X"){if(o.getProperty("/ReworkQty")===""||o.getProperty("/ReworkQty")<=0){o.setProperty("/ValueStateReworkQty","Error");v=false;}else{o.setProperty("/ValueStateReworkQty","None");}}if(o.getProperty("/isTableSerialNumbersVisible")===false&&o.getProperty("/sSelectedButtonKey")!=="SPLT_OS"){var s=o.getProperty("/SplitQty");if(s===""||s<=0||s>=Number(O.getProperty("/OpPlannedTotalQuantity"))){o.setProperty("/ValueStateSplitQty","Error");v=false;}else{o.setProperty("/ValueStateSplitQty","None");}}if(o.getProperty("/OrderTypeIsEditable")){if(sap.ui.getCore().byId("idOSManufacturingOrderType").getValue()===""){o.setProperty("/OrderTypeValueState","Error");v=false;}else{o.setProperty("/OrderTypeValueState","None");}}if(sap.ui.getCore().byId("idOSBasicSchedulingType").getValue()===""){o.setProperty("/ValueStateBasicSchedulingType","Error");v=false;}else{o.setProperty("/ValueStateBasicSchedulingType","None");}if(o.getProperty("/sSelectedButtonKey")==="SPLT_DP"){if(sap.ui.getCore().byId("idOSMaterialChildSF").getValue()===""){v=false;o.setProperty("/ValueStateMaterialChild","Error");}else{o.setProperty("/ValueStateMaterialChild","None");}}if(o.getProperty("/isPMMOActive")===false){if(sap.ui.getCore().byId("idOSByProduct").getValue()===""){v=false;o.setProperty("/ValueStateByProduct","Error");}else{o.setProperty("/ValueStateByProduct","None");}}return v;},onCancel:function(e){this._oOrderSplitDialog.close();},onLiveChangeSplitQty:function(e){if(e.getParameters().newValue!==""&&e.getParameters().newValue!=="0"&&e.getParameters().newValue>=Number(e.getSource().getModel("OperationData").getProperty("/OpPlannedTotalQuantity"))){e.getSource().getModel("OrderSplit").setProperty("/ValueStateSplitQty","Error");e.getSource().getModel("OrderSplit").setProperty("/ValueStateTextSplitQty",e.getSource().getModel("i18n").getResourceBundle().getText("splitQtyMoreOpQty"));}else{e.getSource().getModel("OrderSplit").setProperty("/ValueStateSplitQty","None");e.getSource().getModel("OrderSplit").setProperty("/ValueStateTextSplitQty","");}},onLiveChangeReworkQty:function(e){if(e.getParameters().newValue!==""&&e.getParameters().newValue!=="0"&&e.getParameters().newValue>Number(e.getSource().getModel("OrderSplit").getProperty("/SplitQty"))){e.getSource().getModel("OrderSplit").setProperty("/ValueStateReworkQty","Error");e.getSource().getModel("OrderSplit").setProperty("/ValueStateTextReworkQty",e.getSource().getModel("i18n").getResourceBundle().getText("reworkQtyMoreSplitQty"));}else{e.getSource().getModel("OrderSplit").setProperty("/ValueStateReworkQty","None");e.getSource().getModel("OrderSplit").setProperty("/ValueStateTextReworkQty","");}}};});
